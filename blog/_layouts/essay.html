---
layout: default
---

<article class="essay">
  <div class="reading-progress" aria-hidden="true">
    <span id="reading-progress-bar"></span>
  </div>

  <div class="essay-header">
    <h1 class="essay-title">{{ page.title }}</h1>
    <div class="essay-meta">
      <span class="category">{{ site.category_names[page.category] | default: page.category }}</span>
      <span class="difficulty">{{ site.difficulty_levels[page.difficulty] | default: page.difficulty }}</span>
      {% if page.year %}
      <span class="year">{{ page.year }}</span>
      {% endif %}
    </div>
    <div class="essay-actions">
      <button id="bookmark-btn" class="action-btn" title="ë¶ë§ˆí¬">
        <span class="bookmark-icon">ğŸ”–</span>
        <span class="bookmark-text">ì €ì¥</span>
      </button>
      <a href="{{ page.url_original }}" class="original-link" target="_blank" rel="noopener">ì›ë¬¸ ë³´ê¸° â†’</a>
    </div>
  </div>

  <nav class="toc" id="toc" aria-label="ë³¸ë¬¸ ë°”ë¡œê°€ê¸°">
    <div class="toc-header">
      <p class="toc-title">ë³¸ë¬¸ ë°”ë¡œê°€ê¸°</p>
    </div>
    <ul id="toc-list"></ul>
  </nav>

  <div class="essay-content" id="essay-content">
    {{ content }}
  </div>

  <!-- Highlight Popup -->
  <div id="highlight-popup" class="highlight-popup" style="display: none;">
    <button id="highlight-btn" class="highlight-popup-btn" title="í•˜ì´ë¼ì´íŠ¸">
      <span>ğŸ’¡</span> í•˜ì´ë¼ì´íŠ¸
    </button>
    <button id="remove-highlight-btn" class="highlight-popup-btn" title="í•˜ì´ë¼ì´íŠ¸ ì œê±°" style="display: none;">
      <span>âœ•</span> ì œê±°
    </button>
  </div>

  <!-- Saved Highlights Section -->
  <div id="highlights-section" class="highlights-section" style="display: none;">
    <h3>ë‚´ê°€ ì €ì¥í•œ í•˜ì´ë¼ì´íŠ¸</h3>
    <ul id="highlights-list"></ul>
  </div>

  <div class="essay-footer">
    <a href="{{ '/' | relative_url }}" class="back-link">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

    <div class="share-buttons">
      <button onclick="shareKakao()">ì¹´ì¹´ì˜¤í†¡ ê³µìœ </button>
      <button onclick="copyLink()">ë§í¬ ë³µì‚¬</button>
    </div>
  </div>

  <!-- Comments Section using giscus -->
  <div class="comments-section">
    <h3 class="comments-title">ëŒ“ê¸€</h3>
    <script src="https://giscus.app/client.js"
        data-repo="arenga/YC"
        data-repo-id="R_kgDONbHX7A"
        data-category="General"
        data-category-id="DIC_kwDONbHX7M4Cl-DU"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        data-lang="ko"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
    </script>
  </div>
</article>

<script>
  // ========== Table of Contents ==========
  (function buildToc() {
    const headings = Array.from(document.querySelectorAll('.essay-content h2, .essay-content h3'));
    const tocList = document.getElementById('toc-list');
    if (!headings.length || !tocList) {
      const toc = document.querySelector('.toc');
      if (toc) toc.style.display = 'none';
      return;
    }

    function slugify(text) {
      return text
        .toLowerCase()
        .replace(/[^a-z0-9ê°€-í£\s-]/g, '')
        .trim()
        .replace(/\s+/g, '-');
    }

    headings.forEach((heading) => {
      const text = heading.innerText.trim();
      if (!text) return;
      if (!heading.id) heading.id = slugify(text);
      const li = document.createElement('li');
      li.className = heading.tagName.toLowerCase() === 'h3' ? 'toc-item depth-2' : 'toc-item depth-1';
      const a = document.createElement('a');
      a.href = '#' + heading.id;
      a.textContent = text;
      li.appendChild(a);
      tocList.appendChild(li);
    });
  })();

  // ========== TOC FAB Button ==========
  (function tocFab() {
    const tocFabBtn = document.getElementById('toc-fab');
    const toc = document.getElementById('toc');
    if (!tocFabBtn || !toc) return;
    tocFabBtn.addEventListener('click', () => toc.scrollIntoView({ behavior: 'smooth', block: 'start' }));
  })();

  // ========== Reading Progress Bar ==========
  (function readingProgress() {
    const bar = document.getElementById('reading-progress-bar');
    if (!bar) return;
    function update() {
      const scrollTop = window.scrollY || document.documentElement.scrollTop;
      const docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
      bar.style.width = progress + '%';
    }
    window.addEventListener('scroll', update, { passive: true });
    window.addEventListener('resize', update);
    update();
  })();

  // ========== Bookmark Feature ==========
  (function bookmarkFeature() {
    const bookmarkBtn = document.getElementById('bookmark-btn');
    const currentPage = window.location.pathname;
    const pageTitle = document.querySelector('.essay-title').textContent;
    const storageKey = 'agora-bookmarks';

    function getBookmarks() {
      try {
        return JSON.parse(localStorage.getItem(storageKey)) || [];
      } catch {
        return [];
      }
    }

    function saveBookmarks(bookmarks) {
      localStorage.setItem(storageKey, JSON.stringify(bookmarks));
    }

    function isBookmarked() {
      return getBookmarks().some(b => b.path === currentPage);
    }

    function updateButton() {
      if (isBookmarked()) {
        bookmarkBtn.classList.add('bookmarked');
        bookmarkBtn.querySelector('.bookmark-text').textContent = 'ì €ì¥ë¨';
      } else {
        bookmarkBtn.classList.remove('bookmarked');
        bookmarkBtn.querySelector('.bookmark-text').textContent = 'ì €ì¥';
      }
    }

    bookmarkBtn.addEventListener('click', () => {
      let bookmarks = getBookmarks();

      if (isBookmarked()) {
        bookmarks = bookmarks.filter(b => b.path !== currentPage);
        saveBookmarks(bookmarks);
        alert('ë¶ë§ˆí¬ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } else {
        bookmarks.push({
          path: currentPage,
          title: pageTitle,
          timestamp: Date.now()
        });
        saveBookmarks(bookmarks);
        alert('ë¶ë§ˆí¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
      }

      updateButton();

      // Trigger custom event for other pages to update
      window.dispatchEvent(new Event('bookmarksUpdated'));
    });

    updateButton();
  })();

  // ========== Text Highlight Feature ==========
  (function highlightFeature() {
    const popup = document.getElementById('highlight-popup');
    const highlightBtn = document.getElementById('highlight-btn');
    const removeHighlightBtn = document.getElementById('remove-highlight-btn');
    const content = document.getElementById('essay-content');
    const storageKey = 'agora-highlights-' + window.location.pathname;

    let currentSelection = null;

    function getHighlights() {
      try {
        return JSON.parse(localStorage.getItem(storageKey)) || [];
      } catch {
        return [];
      }
    }

    function saveHighlights(highlights) {
      localStorage.setItem(storageKey, JSON.stringify(highlights));
      displaySavedHighlights();
    }

    function displaySavedHighlights() {
      const highlights = getHighlights();
      const section = document.getElementById('highlights-section');
      const list = document.getElementById('highlights-list');

      if (highlights.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      list.innerHTML = '';

      highlights.forEach((hl, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="saved-highlight">
            <p class="highlight-text">"${hl.text}"</p>
            <button class="remove-saved-highlight" data-index="${index}">ì‚­ì œ</button>
          </div>
        `;
        list.appendChild(li);
      });

      // Add delete handlers
      list.querySelectorAll('.remove-saved-highlight').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.index);
          let highlights = getHighlights();
          highlights.splice(index, 1);
          saveHighlights(highlights);
        });
      });
    }

    // Show/hide popup on text selection
    document.addEventListener('mouseup', (e) => {
      const selection = window.getSelection();
      const selectedText = selection.toString().trim();

      if (selectedText && content.contains(selection.anchorNode)) {
        currentSelection = {
          text: selectedText,
          range: selection.getRangeAt(0).cloneRange()
        };

        const rect = selection.getRangeAt(0).getBoundingClientRect();
        popup.style.display = 'flex';
        popup.style.top = (rect.top + window.scrollY - 50) + 'px';
        popup.style.left = (rect.left + rect.width / 2) + 'px';

        // Check if already highlighted
        const parent = selection.anchorNode.parentElement;
        if (parent && parent.classList.contains('user-highlight')) {
          highlightBtn.style.display = 'none';
          removeHighlightBtn.style.display = 'block';
        } else {
          highlightBtn.style.display = 'block';
          removeHighlightBtn.style.display = 'none';
        }
      } else if (!popup.contains(e.target)) {
        popup.style.display = 'none';
      }
    });

    // Add highlight
    highlightBtn.addEventListener('click', () => {
      if (!currentSelection) return;

      const highlights = getHighlights();
      highlights.push({
        text: currentSelection.text,
        timestamp: Date.now()
      });
      saveHighlights(highlights);

      // Apply visual highlight
      try {
        const range = currentSelection.range;
        const span = document.createElement('mark');
        span.className = 'user-highlight';
        range.surroundContents(span);
      } catch (e) {
        console.error('Could not apply highlight:', e);
      }

      popup.style.display = 'none';
      window.getSelection().removeAllRanges();
    });

    // Remove highlight
    removeHighlightBtn.addEventListener('click', () => {
      const selection = window.getSelection();
      const parent = selection.anchorNode.parentElement;

      if (parent && parent.classList.contains('user-highlight')) {
        const text = parent.textContent;
        parent.replaceWith(document.createTextNode(text));

        let highlights = getHighlights();
        highlights = highlights.filter(h => h.text !== text);
        saveHighlights(highlights);
      }

      popup.style.display = 'none';
      window.getSelection().removeAllRanges();
    });

    displaySavedHighlights();
  })();

  // ========== Share Functions ==========
  function copyLink() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
      alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    });
  }

  function shareKakao() {
    alert('ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
  }

  // ========== Giscus Theme Sync ==========
  (function syncGiscusTheme() {
    const observer = new MutationObserver(() => {
      const theme = document.documentElement.getAttribute('data-theme');
      const iframe = document.querySelector('iframe.giscus-frame');
      if (iframe) {
        iframe.contentWindow.postMessage({
          giscus: { setConfig: { theme: theme === 'dark' ? 'dark' : 'light' } }
        }, 'https://giscus.app');
      }
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-theme']
    });
  })();
</script>
